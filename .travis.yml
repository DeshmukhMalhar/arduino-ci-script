# This file is used to test the script with Travis CI

language: bash
sudo: required


env:
  global:
    # The Arduino IDE will be installed at APPLICATION_FOLDER/arduino
    - APPLICATION_FOLDER="/usr/local/share"
    - SKETCHBOOK_FOLDER="${HOME}/Arduino"
  matrix:
    # Test install_ide using full version list
    - INSTALL_IDE_START_VERSION="all"
    # Test install_ide using custom version list
    - INSTALL_IDE_START_VERSION='("1.6.9" "1.8.1" "hourly")'
    # Test install_ide using single version
    - INSTALL_IDE_START_VERSION="1.8.1"
    # Test install_ide using custom version range
    - INSTALL_IDE_START_VERSION="1.8.0" INSTALL_IDE_END_VERSION="1.8.2"
    # Test install_ide using "oldest" special version name (must install up to 1.6.4 for the installation of Arduino SAM Boards to work)
    - INSTALL_IDE_START_VERSION="oldest" INSTALL_IDE_END_VERSION="1.8.1"
    # Test install_ide using "newest" special version name
    - INSTALL_IDE_START_VERSION="1.8.0" INSTALL_IDE_END_VERSION="newest"


before_install:
  # https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html
  # Uncomment the following lines to get verbose script output for debugging
  # Print shell input lines as they are read.
  #- set -v
  # Print a trace of simple commands.
  #- set -x

  - source "${TRAVIS_BUILD_DIR}/arduino-ci-script.sh"

  # set_parameters arguments: folder to install the Arduino IDE to, Sketchbook folder, Enable verbose output during compilation
  - set_parameters "$APPLICATION_FOLDER" "$SKETCHBOOK_FOLDER" "false"


install:
  - install_ide "$INSTALL_IDE_START_VERSION" "$INSTALL_IDE_END_VERSION"

  # Install hardware packages
  # Test package install without URL
  - install_package "arduino:sam"
  # Test package install with URL
  - install_package "MiniCore:avr" "https://mcudude.github.io/MiniCore/package_MCUdude_MiniCore_index.json"

  # Test library installation from repository (can't do this because there is no library in this repository)
  - install_library_from_repo

  # Test library install from .zip file. If the rename doesn't work then any job verifying with Arduino IDE 1.5.6 or older will hang because GitHub changes the folder name to WatchdogLog-master, which is not a valid folder name on those IDE versions.
  - install_library_dependency "https://github.com/per1234/WatchdogLog/archive/master.zip" "WatchdogLog"
  # Test library install from git repo
  - install_library_dependency "https://github.com/per1234/EEPROMallocation.git"
  # Test library install from Library Manager
  - install_library_dependency_via_library_manager "Adafruit NeoPixel"


script:
  # Verify sketches:
  # build_sketch arguments: sketch name, fqbn, IDE version, allow failure
  # IDE version: Use "all" for IDE version argument to verify sketch with all versions of the Arduino IDE, use "newest" for IDE version argument to verify sketch with the newest version of the Arduino IDE

  # Installed package tests:
  # Test sketch verification using board from hardware package installed without URL
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "arduino:sam:arduino_due_x_dbg" "newest" "false"
  # Test sketch verification using board from hardware package installed with URL
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "MiniCore:avr:328:variant=modelP,BOD=2v7,LTO=Os,clock=16MHz_external" "newest" "false"

  # Installed library tests:
  # Test sketch verification using library installed from .zip
  - build_sketch "${SKETCHBOOK_FOLDER}/libraries/WatchdogLog/examples/WatchdogLogExample/WatchdogLogExample.ino" "arduino:avr:mega:cpu=atmega2560" "newest" "false"
  # Test sketch verification using library installed from .git
  - build_sketch "${SKETCHBOOK_FOLDER}/libraries/EEPROMallocation/examples/EEPROMallocationExample/EEPROMallocationExample.ino" "arduino:avr:mega:cpu=atmega2560" "newest" "false"
  # Test sketch verification using library installed from Library Manager
  - build_sketch "${SKETCHBOOK_FOLDER}/libraries/Adafruit_NeoPixel/examples/simple/simple.ino" "arduino:avr:mega:cpu=atmega2560" "newest" "false"

  # build_sketch with sketch argument tests:
  # Test sketch verification with specific IDE version
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "arduino:avr:mega:cpu=atmega2560" "1.8.1" "false"
  # Test sketch verification with "oldest" IDE versions (must use Uno because fqbn for Mega 2560 is different with old IDE versions)
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "arduino:avr:uno" "oldest" "false"
  # Test sketch verification with "newest" IDE versions
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "arduino:avr:mega:cpu=atmega2560" "newest" "false"
  # Test sketch verification with all IDE versions (must use Uno because fqbn for Mega 2560 is different with old IDE versions)
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics/Blink/Blink.ino" "arduino:avr:uno" "all" "false"

  # Test sketch verification allowed to fail (this will fail because WatchdogLog is AVR specific)
  - build_sketch "${SKETCHBOOK_FOLDER}/libraries/WatchdogLog/examples/WatchdogLogExample/WatchdogLogExample.ino" "arduino:sam:arduino_due_x_dbg" "newest" "true"

  # build_sketch with folder argument tests:
  # Test build_sketch with specific IDE version
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics" "arduino:avr:mega:cpu=atmega2560" "1.8.1" "false"
  # Test build_sketch with "oldest" IDE version (must use Uno because fqbn for Mega 2560 is different with old IDE versions)
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics" "arduino:avr:uno" "oldest" "false"
  # Test build_sketch with "newest" IDE version
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics" "arduino:avr:mega:cpu=atmega2560" "newest" "false"
  # Test build_sketch with all IDE versions (must use Uno because fqbn for Mega 2560 is different with old IDE versions)
  - build_sketch "${APPLICATION_FOLDER}/arduino/examples/01.Basics" "arduino:avr:uno" "all" "false"

  # Test build_sketch allowed to fail (this will fail because WatchdogLog is AVR specific)
  - build_sketch "${SKETCHBOOK_FOLDER}/libraries/WatchdogLog/examples" "arduino:sam:arduino_due_x_dbg" "newest" "true"

  - display_report
  - check_success


notifications:
  email:
    on_success: always
    on_failure: always
